<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
  <meta name="description" content="description of your site">
  <meta name="author" content="author of the site">
  <title>YKit 项目迁移</title>
  <link rel="stylesheet" href="source/main.css"/>
  
</head>
<body>
    <div class="ydoc">
      <header class="ydoc-header">
        <div class="ydoc-header-area">
            
            <a href="http://ued.qunar.com/ymfe/" class="navbar-brand">YMFE</a>
            
            <button class="ydocIcon navbar-toggle">&#xf020;</button>
            <nav class="ydoc-nav">
              <ul class="navbar-left">
                
                    
                    <li class="">
                        
                        <a href="index.html">简介</a>
                        
                    </li>
                    
                    <li class="active">
                        
                        <a href="migrate.html">项目迁移</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="docs.html">使用手册</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="releases.html">版本记录</a>
                        
                    </li>
                    
                
              </ul>
            </nav>
        </div>
    </header>
    
    <!-- <header style="height:20px"></header> -->
    
      <!-- Docs page layout -->
      
      <div class="ydoc-banner-bg">
          <div class="ydoc-banner">
              <div class="ydoc-banner-area">
                  <h1>Ykit</h1>
                  <p>Migration</p>
              </div>
          </div>
      

      <div class="ydoc-container">
        
          
          <div class="ydoc-container-content">
              <div class="content-left" role="complementary">
                  <nav class="docs-sidebar hidden-print hidden-xs hidden-sm">
                    <ul class="nav docs-sidenav">
                        
                        
                        <!-- <li  > -->
                        <li >
                            
                            <a href="migrate-如何迁移 fekit 项目.html">如何迁移 fekit 项目</a>
                            
                        </li>
                        
                        
                        
                        <!-- <li  > -->
                        <li >
                            
                            <a href="migrate-如何迁移 webpack 项目.html">如何迁移 webpack 项目</a>
                            
                        </li>
                        
                        
                    </ul>
                  </nav>
              </div>
              <div class="content-right markdown-body" role="main">

                
                <h1 style="font-weight: normal"> 将FEkit项目迁移到YKit </h1>

<h2 style="font-weight:normal"> 生成package.json </h2>

<p>首先需要调用 <code>npm init</code>生成package.json文件，一路点回车即可。</p>
<h2 style="font-weight: normal"> 下载依赖 </h2>

<p>迁移所需要的依赖是<code>@qnpm/ykit-config-fekit</code>包：</p>
<pre><code>qnpm i @qnpm/ykit-config-fekit --save
</code></pre><p>然后包的postinstall脚本会帮你创建<code>ykit.fekit.js</code>到项目根目录下。</p>
<p>所有fekit.config中的有效配置（和构建和发布相关的配置）会被拷贝到ykit.fekit.js中，今后在这个文件中修改即可。</p>
<p>目前没有计划支持fekit install和fekit plugin（例如qmb）相关的配置项。</p>
<p><strong> 你需要将package.json和ykit.fekit.js两个文件加入到git版本控制中（调用git add），node_modules不需要add。 </strong></p>
<h2 style="font-weight: normal"> 尝试迁移 </h2>

<p><strong> 以下内容非常重要，请仔细阅读后再进行操作 </strong></p>
<h3 style="font-weight: normal"> 目前不支持的项目类型： </h3>

<ul>
<li>使用了<code>scripts</code>(premin,prepack,postmin,postpack,prepublish)钩子脚本的项目</li>
<li>各种利用了非常规fekit bug的项目（例如使用注释来require依赖）</li>
</ul>
<p>以上几类项目目前完全无法迁移，会逐次提供支持，请等待之后版本的ykit-config-fekit。</p>
<p>另外，如果是先使用webpack构建再用FEkit发布的项目，也可以迁移，但是需要手动执行webpack构建过程先生成pack后的文件。</p>
<h3 style="font-weight: normal"> 可能存在的问题 </h3>

<p>目前发现FEKit的模块加载器并未严格遵守CommonJS标准，它的模块ID和文件内容的md5 hash相关，这在一部分依赖了全局变量的项目中可能会导致大bug。
根本原因是：某些文件内容相同的模块，在FEKit下会被编译成一个module，而在YKit下是两个。</p>
<p>举例说明，假如项目中依赖了avalon.js又依赖了oniui，这表面上不会有问题，但是oniui内部的fekit_modules文件夹包含了avalon的依赖，这两个文件的内容完全相同，
这会导致在YKit构建出来的js中avalon.js中的逻辑被执行两次，而FEKit构建的js只会执行一次（实际上，YKit的构建结果才是正确的）。
由于avalon的插件如<code>mmRequest</code>,<code>mmPromise</code>都是扩展的window.avalon对象，执行两次avalon.js的结果就是
之前挂载的插件会被完全覆盖。这将导致整个项目不可用。</p>
<p>如果在迁移后控制台报出某个全局变量的方法找不到的错误，就很有可能是这种问题。目前这一类项目还没找到快捷的迁移方法，请先不要独自尝试。</p>
<h3 style="font-weight: normal"> 迁移步骤 </h3>

<h4 style="font-weight: normal"> 1. 本地pack </h4>

<p>首先请在项目根目录下调用<code>ykit pack -c</code>生成dev文件。然后注意看一下命令行可能出现的报错，例如：</p>
<pre><code> X ./~/css-loader?-url!./~/@qnpm/ykit-config-fekit/loaders/fekit-scss.js!./src/styles/expcleisure-index.css
Module build failed: Missed semicolon (87:127)

  85 | .b_event_description{ padding-bottom:10px; }
  86 | .b_event_description .e_process{ padding:15px 0 8px 85px; text-align:center; }
&gt; 87 | .b_event_description .e_process li{ margin-left:12px; padding-right:36px; width:158px; display:inline; float:left; background:background:url(http://source.qunar.com/site/images/zhuanti/130424-1/icon.png) no-repeat 100% 44px; }
     |                                                                                                                               ^
  88 | .b_event_description .e_process li.last{ background:none; }
  89 | .b_event_description .e_process .step_01, .b_event_description .e_process .step_02, .b_event_description .e_process .step_03, .b_event_description .e_process .step_04{ width:158px; height:114px; background:url(http://source.qunar.com/site/images/zhuanti/130424-1/step.png) no-repeat 0 0; overflow:hidden; }
  90 | .b_event_description .e_process .step_02{ background-position:0 -125px; }
</code></pre><p>由于FEkit不会校验css的语法，因此我们发现大部分的项目都存在类似的各种css错误，这在ykit不再被允许，你需要手动修改这些错误以后再尝试迁移。</p>
<p>另外一种错误是样式的循环依赖问题，例如在文件a中有<code>@import &#39;a&#39;;</code>的语句，这在FEKit中会被默默无视，但是在YKit里不再被允许。
在构建过程中你可以看到如下的错误提示：</p>
<pre><code>X ./~/css-loader?-url!./~/@qnpm/ykit-config-fekit/loaders/fekit-scss.js!./src/yo/endorse-progress/page/endorse-progress.scss
Module build failed: Error: [ykit-config-fekit]: 发现循环依赖config，位于文件/Users/chenjiao/Documents/qzz/complaint/src/yo/endorse-progress/core/config.scss中，请检查。
</code></pre><p>请修复错误以后再继续尝试。</p>
<p>另外，在js中也可能出现语法错误，例如：</p>
<pre><code>X ./src/scripts/a/touch/recruitSleeper/index.js
Module not found: Error: Cannot resolve module &#39;prepareSleeper/index/js&#39; in /Users/chenjiao/Documents/qzz/ugc/src/scripts/a/touch/recruitSleeper
 @ ./src/scripts/a/touch/recruitSleeper/index.js 5:0-34
</code></pre><p>这个错误对应的源码长这个样子：</p>
<pre><code>require(&quot;prepareSleeper/index/js&quot;);
</code></pre><p>这种错误在fekit中也被默默地无视掉了，请参照报错信息进行修改。</p>
<p>请重复以上两个步骤，直到没有报错为止。</p>
<h4 style="font-weight: normal"> 2. dev测试 </h4>

<p>调用<code>ykit sync</code>可以将项目sync到开发机，然后请修改host进行dev测试（这个就不多说怎么弄了）。</p>
<p>最好每个页面都看一下是否有问题。</p>
<h4 style="font-weight: normal"> beta/正式发布 </h4>

<p>按流程走即可。</p>
<h2 style="font-weight: normal"> 支持 </h2>

<p>请qtalk jiao.shen或者yuhao.ju</p>
<h2 style="font-weight: normal"> 已经转化成功的项目列表 </h2>

<p>注意，以下的项目绝大多数都有上面提到的css语法问题和js引用问题，都是手动修复以后转化成功的：</p>
<ul>
<li>ugc_mall</li>
<li>ugc</li>
<li>ugchybrid</li>
<li>ugc_mall_admin</li>
<li>ugc_review_audit</li>
<li>ugc_topic</li>
<li>trainticket</li>
<li>hotel_fekit</li>
<li>bnb_fekit</li>
<li>bnbhybrid</li>
<li>hotel_luxury</li>
<li>mice_search_fekit</li>
<li>mice_operation_fekit</li>
</ul>

              </div>
          </div>
          
        
      </div>
     
     </div>
     
      <footer class="footer">
        <div class="copyright">
            &copy; 2016 <a href="http://ued.qunar.com/ymfe/">YMFE Team</a>. Build by <a href="http://github.com/YMFE/ydoc">ydoc</a>
        </div>
      </footer>
    </div>
    <script src="source/main.js"></script>
    <script src="source/app.js"></script>
    
    

    

</body>
</html>
